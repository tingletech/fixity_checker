<!DOCTYPE html>

<html>
<head>
  <title>fixity_checker.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>fixity_checker.py</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">#!/usr/bin/env python</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>-<em>- coding: utf-8 -</em>-</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-string">"""
Yet another fixity checker
server daemon
"""</span>
<span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> (absolute_import, division,
                        print_function, unicode_literals)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>⏣ ⏣  <a href="https://github.com/tingletech/fixity_checker">https://github.com/tingletech/fixity_checker</a> ⏣ ⏣</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>APP_NAME = <span class="hljs-string">'fixity_checker'</span>
__version__ = <span class="hljs-string">'0.4.0'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>I went a little crazy with unicode characters, ⌦  ⏢  ⎄
are used to group comments at a similar heading,
☞ ☟ for zig-zags in flow, and ⏏ marks an exit point.  My
goal is to make it easy to scan, since this is a long code.</p>
<p>Please <a href="https://github.com/tingletech/fixity_checker/issues">let me know</a>
if you have any issues, ideas, or suggestions.</p>
<p>―Brian Tingle, Oakland, California</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> daemonocle
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">from</span> appdirs <span class="hljs-keyword">import</span> user_data_dir
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> pprint <span class="hljs-keyword">import</span> pprint <span class="hljs-keyword">as</span> pp
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> namedtuple, defaultdict
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> logging.handlers
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> psutil
<span class="hljs-keyword">from</span> six.moves <span class="hljs-keyword">import</span> cStringIO
<span class="hljs-keyword">from</span> six.moves.urllib <span class="hljs-keyword">import</span> parse <span class="hljs-keyword">as</span> urlparse
<span class="hljs-keyword">from</span> six.moves <span class="hljs-keyword">import</span> input
<span class="hljs-keyword">import</span> six
<span class="hljs-keyword">import</span> gc
<span class="hljs-keyword">import</span> fnmatch
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">from</span> shove <span class="hljs-keyword">import</span> Shove</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>use <code>readline</code> if it is available for interactive input in init</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">import</span> readline   <span class="hljs-comment"># noqa</span>
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-keyword">pass</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>default directory for program files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">try</span>:
    CHECKER_DIR = os.environ[<span class="hljs-string">'CHECKER_DIR'</span>]
<span class="hljs-keyword">except</span> KeyError:
    CHECKER_DIR = user_data_dir(APP_NAME, <span class="hljs-string">'cdlib'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>⌦
main function for command line interface
⌦</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(argv=None)</span>:</span>
    <span class="hljs-string">"""main: argument parsing and daemon setup"""</span>
    parser = argparse.ArgumentParser(
        epilog=<span class="hljs-string">'using CHECKER_DIR="{0}"; use -d dir after \
        subcommand or change env to use different config \
        dir\n\t{1} {2}'</span>.format(CHECKER_DIR, APP_NAME, __version__)
    )

    subparsers = parser.add_subparsers(dest=<span class="hljs-string">'subparser_name'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>⏢
list all subcommands and what they do
⏢</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    commands = [
        (<span class="hljs-string">'init'</span>, <span class="hljs-string">'runs and interactive script to configure a checker server'</span>),
        (<span class="hljs-string">'show_conf'</span>, <span class="hljs-string">'validate and show configuration options'</span>),
        (<span class="hljs-string">'start'</span>, <span class="hljs-string">'starts the checker server'</span>),
        (<span class="hljs-string">'stop'</span>, <span class="hljs-string">'stops the checker server'</span>),
        (<span class="hljs-string">'status'</span>, <span class="hljs-string">'produces a report of the server status'</span>),
        (<span class="hljs-string">'errors'</span>, <span class="hljs-string">'reports on any fixity errors that have been found'</span>),
        (<span class="hljs-string">'extent'</span>, <span class="hljs-string">'files / bytes under observation'</span>),
        (<span class="hljs-string">'restart'</span>, <span class="hljs-string">'stop follow by a start'</span>),
        (<span class="hljs-string">'update'</span>, <span class="hljs-string">'updates fixity info (server must be stopped)'</span>),
        (<span class="hljs-string">'json_report'</span>, <span class="hljs-string">'json serialization of application data'</span>),
        (<span class="hljs-string">'json_load'</span>, <span class="hljs-string">'load json serialization into application data'</span>),
    ]</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>⏢
set up parsers for the subcommands
⏢</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    parsers = {}
    thismodule = sys.modules[__name__]

    <span class="hljs-keyword">for</span> command, help <span class="hljs-keyword">in</span> commands:
        parsers[command] = subparsers.add_parser(command,
                                                 help=help,
                                                 description=help)
        <span class="hljs-keyword">if</span> command <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'start'</span>, <span class="hljs-string">'stop'</span>, <span class="hljs-string">'restart'</span>, <span class="hljs-string">'update'</span>]:</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>map sub command to the function named <em>command</em> in this file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            parsers[command].set_defaults(func=getattr(thismodule, command))</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>some subcommands need custom arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parsers[<span class="hljs-string">'start'</span>].add_argument(
        <span class="hljs-string">'--no-detach'</span>, dest=<span class="hljs-string">'detach'</span>, action=<span class="hljs-string">'store_false'</span>
    )
    parsers[<span class="hljs-string">'update'</span>].add_argument(<span class="hljs-string">'file'</span>, nargs=<span class="hljs-string">'+'</span>, help=<span class="hljs-string">'file(s) to update'</span>)
    parsers[<span class="hljs-string">'update'</span>].add_argument(<span class="hljs-string">'--remove'</span>,
                                   action=<span class="hljs-string">'store_true'</span>, 
                                   help=<span class="hljs-string">'file removed'</span>)
    parsers[<span class="hljs-string">'json_report'</span>].add_argument(<span class="hljs-string">'report_directory'</span>, nargs=<span class="hljs-number">1</span>)
    parsers[<span class="hljs-string">'json_load'</span>].add_argument(<span class="hljs-string">'report_directory'</span>, nargs=<span class="hljs-number">1</span>)
    parsers[<span class="hljs-string">'init'</span>].add_argument(<span class="hljs-string">'--archive_paths'</span>, nargs=<span class="hljs-string">'+'</span>,
                                 dest=<span class="hljs-string">'archive_paths'</span>,
                                 help=<span class="hljs-string">'directories to check'</span>)
    group = parsers[<span class="hljs-string">'show_conf'</span>].add_mutually_exclusive_group()
    group.add_argument(<span class="hljs-string">'--log_file'</span>, action=<span class="hljs-string">'store_true'</span>)
    group.add_argument(<span class="hljs-string">'--pid_file'</span>, action=<span class="hljs-string">'store_true'</span>)
    group.add_argument(<span class="hljs-string">'--dir'</span>, action=<span class="hljs-string">'store_true'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>add CHECKER_DIR config_dir to the end of each parser
will show up at bottom of the help this way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> command, ____ <span class="hljs-keyword">in</span> commands:
        parsers[command].add_argument(<span class="hljs-string">'-d'</span>, dest=<span class="hljs-string">'config_dir'</span>,
                                      default=CHECKER_DIR,
                                      help=<span class="hljs-string">'configuration directory'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>⏢
parse the arguments and dispatch to correct function
⏢</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>hacky python 3 portage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> len(sys.argv) == <span class="hljs-number">1</span>:
        sys.argv.append(<span class="hljs-string">''</span>)

    <span class="hljs-keyword">if</span> argv <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
        argv = parser.parse_args()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>need to init before there is a conf to parse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">'init'</span>:
        <span class="hljs-keyword">return</span> init(argv)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>will fail if the conf does not parse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    conf = _parse_conf(argv)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>start to set up daemon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    detach = <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'detach'</span> <span class="hljs-keyword">in</span> argv:
        detach = argv.detach
    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">'update'</span>:
        detach = <span class="hljs-keyword">False</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>callbacks for daemon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main_loop_wrapper</span><span class="hljs-params">()</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><code>while True</code> wrapper nested here to gain access to parsed <code>conf</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        log_nice(conf)
        logging.info(<span class="hljs-string">'Daemon is starting'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>persisted dict interface for long term memory
<a href="https://pypi.python.org/pypi/shove/">https://pypi.python.org/pypi/shove/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        observations = Shove(conf.data[<span class="hljs-string">'data_url'</span>], protocol=<span class="hljs-number">2</span>)
        errors = Shove(<span class="hljs-string">'file://{0}'</span>.format(conf.app.errors), protocol=<span class="hljs-number">2</span>,)
        <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
            checker(conf, observations, errors)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cb_shutdown</span><span class="hljs-params">(message, code)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>don’t have access to observations or errror here; pull these out
a level so we can close them?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> conf.args.subparser_name != <span class="hljs-string">'update'</span>:
            logging.info(<span class="hljs-string">'Daemon is stopping'</span>)
            logging.debug(message)

    daemon = daemonocle.Daemon(
        worker=main_loop_wrapper,
        workdir=os.getcwd(),
        shutdown_callback=cb_shutdown,
        pidfile=conf.daemon.pid,
        detach=detach
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>use daemonocle for these subcommands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] <span class="hljs-keyword">in</span> [<span class="hljs-string">'start'</span>, <span class="hljs-string">'stop'</span>, <span class="hljs-string">'restart'</span>]:
        daemon.do_action(sys.argv[<span class="hljs-number">1</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>updates are a special case, note we are calling <code>start</code> on
the daemon, so the daemon can’t be running when we update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">'update'</span>:
        daemon.do_action(<span class="hljs-string">'start'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>use argparse subcommands mapped to internal function names
for any other commands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> argv.func(conf, daemon)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>⌦
main loop that runs as daemon
⌦</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checker</span><span class="hljs-params">(conf, observations, errors)</span>:</span>
    <span class="hljs-string">""" the main loop """</span>
    startLoopTime = time.time()</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>☞
  <code>update</code> the database and quit (main loop must not be running)
☞</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> conf.args.subparser_name == <span class="hljs-string">'update'</span>:
        logging.warning(<span class="hljs-string">'altering memories'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>TODO right now this does not handle s3; only local files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> conf.args.file:
            path = os.path.abspath(f)
            print(path)
            filename_key = hashlib.sha224(path.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest()
            <span class="hljs-keyword">if</span> conf.args.remove:
                <span class="hljs-keyword">del</span> observations[filename_key]
                observations.sync()
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">for</span> hashtype <span class="hljs-keyword">in</span> conf.data[<span class="hljs-string">'hashlib'</span>]:
                    check_one_file(
                        path, observations, hashtype, <span class="hljs-keyword">True</span>, conf, errors
                    )
                    observations.sync()</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>clear errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            errors.pop(filename_key, <span class="hljs-keyword">None</span>)
            errors.sync()
        observations.close()
        errors.close()
        exit(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>⏏  exit the program</p>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>☟
 not an <code>update</code>, continue down the loop
☟</p>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>TODO; set up var for counts</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>⎄ check the hashes
for each hash type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> hashtype <span class="hljs-keyword">in</span> conf.data[<span class="hljs-string">'hashlib'</span>]:
        logging.info(<span class="hljs-string">'starting {0} checks'</span>.format(hashtype))</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>for each <code>archive_paths</code> in configuration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> filepath <span class="hljs-keyword">in</span> conf.data[<span class="hljs-string">'archive_paths'</span>]:
            <span class="hljs-keyword">assert</span> filepath, <span class="hljs-string">"arguments can't be empty"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><code>+&#39;&#39;</code> 2/3 unicode compatibility <a href="http://fomori.org/blog/?p=486">http://fomori.org/blog/?p=486</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            filepath = filepath+<span class="hljs-string">''</span>

            check_one_arg(
                filepath, observations, hashtype, <span class="hljs-keyword">False</span>, conf, errors
            )</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>⎄ check for missing files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    logging.info(<span class="hljs-string">'looking for missing files'</span>)
    <span class="hljs-keyword">for</span> ____, value <span class="hljs-keyword">in</span> six.iteritems(observations):
        <span class="hljs-keyword">if</span> value[<span class="hljs-string">'path'</span>].startswith(<span class="hljs-string">'s3://'</span>):</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO: check to make sure this file is still on s3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">pass</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO: check to make sure this file is still on s3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">elif</span> <span class="hljs-keyword">not</span> os.path.isfile(value[<span class="hljs-string">'path'</span>]):
            track_error(
                value[<span class="hljs-string">'path'</span>],
                <span class="hljs-string">"{0} no longer exists or is not a file"</span>.format(value[<span class="hljs-string">'path'</span>]),
                errors
            )</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>⎄ output json reports</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fixity_checker_report(observations, conf.app.json_dir)
    logging.info(<span class="hljs-string">'writting reports at {0}'</span>.format(conf.app.json_dir))</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>⎄ end of loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    gc.collect()
    elapsedLoopTime = time.time() - startLoopTime
    logging.info(<span class="hljs-string">"elapsedLoopTime {0}"</span>.format(elapsedLoopTime))

    <span class="hljs-keyword">if</span> elapsedLoopTime &lt; conf.data[<span class="hljs-string">'min_loop'</span>]:</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><code>min_loop</code> is the shortest time it should take to do a
loop, take a nap if we are done too soon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        nap = conf.data[<span class="hljs-string">'min_loop'</span>] - elapsedLoopTime
        logging.info(<span class="hljs-string">'sleeping for {0}'</span>.format(nap))
        time.sleep(nap)</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>⌦
file checking functions
⌦</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_one_arg</span><span class="hljs-params">(filein, observations, hash, update, conf, errors)</span>:</span>
    <span class="hljs-string">"""check if the arg is a file or directory, walk directory for files"""</span>
    <span class="hljs-keyword">if</span> os.path.isdir(filein):
        <span class="hljs-keyword">for</span> root, ____, files <span class="hljs-keyword">in</span> os.walk(filein):
            <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:
                fullpath = os.path.join(root, f)
                check_one_file(
                    fullpath, observations, hash, update, conf, errors
                )
    <span class="hljs-keyword">elif</span> filein.startswith(<span class="hljs-string">'s3://'</span>):
        <span class="hljs-keyword">import</span> boto
        parts = urlparse.urlsplit(filein)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><a href="https://docs.python.org/2/library/urlparse.html#urlparse-result-object">urlparse-result-object</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        bucket = boto.connect_s3().lookup(parts.netloc)
        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> bucket.list():</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>look for files that match the user supplied path,
acts like recursive directory search</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> parts.path <span class="hljs-keyword">or</span> key.name.startswith(parts.path[<span class="hljs-number">1</span>:]):
                check_one_file(key, observations, hash, update, conf, errors)
    <span class="hljs-keyword">else</span>:
        check_one_file(filein, observations, hash, update, conf, errors)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_one_file</span><span class="hljs-params">(filein, observations, hash, update, conf, errors)</span>:</span>
    <span class="hljs-string">"""check one file (or s3 key) against our memories
    :filein: can be a filename or and AWS s3 key
    :observations: is a dict like object persisting our memories
    :hash: is the name of the hash function
    :update: is True or False (alter memory)
    :conf: is a nested named tuple parsed from the conf
    :errors: is a dict like object persisting noted errors
    has side effects on observations and memories
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">import</span> boto.s3.key
    <span class="hljs-keyword">except</span> ImportError:
        <span class="hljs-keyword">pass</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>set up nap here so we don’t have to pass conf further down,
makes it eaiser to unit test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    nap = NapContext(conf.data[<span class="hljs-string">'sleepiness'</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>test what type got passed in to :filein:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filename = <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>we don’t know if boto will be installed, must be better way
to detect if <code>filein</code> a string (ahem, unicode thingy) or an
AWS key than the try/except here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    s3 = <span class="hljs-keyword">False</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>do I have a local filesystem path or s3 bucket key?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> isinstance(filein, six.string_types):
        filename = os.path.abspath(filein)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> type(filein) <span class="hljs-keyword">is</span> boto.s3.key.Key:
            s3 = <span class="hljs-keyword">True</span>
            filename = <span class="hljs-string">'s3://{0}/{1}'</span>.format(filein.bucket.name,
                                             filein.name)
    <span class="hljs-keyword">except</span> NameError:
        <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">if</span> conf.app.ignore_re <span class="hljs-keyword">and</span> re.match(conf.app.ignore_re, filename):
        logging.debug(<span class="hljs-string">'skipped {0}'</span>.format(filename))
        <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>normalize filename, take hash for key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filename_key = hashlib.sha224(filename.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest()
    logging.info(<span class="hljs-string">'{0}'</span>.format(filename))
    logging.debug(<span class="hljs-string">'sha224 of path {0}'</span>.format(filename_key))</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>dispatch, these are ripe for refactoring to take
a file object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> s3:
        seen_now = analyze_s3_key(filein, hash, nap)
    <span class="hljs-keyword">else</span>:
        seen_now = analyze_file(filename, hash, nap)

    logging.debug(<span class="hljs-string">'seen_now {0}'</span>.format(seen_now))</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>make sure things match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> filename_key <span class="hljs-keyword">in</span> observations <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> update:
        news = {}
        looks_the_same = compare_sightings(
            seen_now, observations[filename_key], news
        )
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> looks_the_same:
            track_error(filename, <span class="hljs-string">"%r has changed"</span> % filename, errors)
        <span class="hljs-keyword">elif</span> any(news):
            update = observations[filename_key]
            update.update(news)
            observations[filename_key] = update
            observations.sync()
            logging.debug(<span class="hljs-string">'new memory {0}'</span>.format(news))</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>update observations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>:
        observations[filename_key] = seen_now
        observations.sync()
        logging.info(<span class="hljs-string">'update observations'</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_sightings</span><span class="hljs-params">(now, before, news={})</span>:</span>
    <span class="hljs-string">""" return False if sightings differ, otherwise True """</span>
    logging.debug(<span class="hljs-string">'now {0} before {1}'</span>.format(now, before))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> now[<span class="hljs-string">'size'</span>] == before[<span class="hljs-string">'size'</span>]:
        logging.error(<span class="hljs-string">'sizes do not match'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>using <code>now.keys()</code> actually checks the size again,
only one new hash key/value comes in at a time right now,
but I guess we could compute multiple checksums at once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> check <span class="hljs-keyword">in</span> list(now.keys()):
        <span class="hljs-keyword">if</span> check <span class="hljs-keyword">in</span> before:
            <span class="hljs-keyword">if</span> now[check] != before[check]:
                logging.error(<span class="hljs-string">'{2} differ before:{1} now:{0}'</span>.format(
                    now[check], before[check], check)
                )
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">else</span>:
            logging.info(<span class="hljs-string">'{0} not seen before for this'</span>.format(check))
            news[check] = now[check]
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_file</span><span class="hljs-params">(filename, hash, nap)</span>:</span>
    <span class="hljs-string">""" returns a dict of hash and size in bytes """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><a href="http://www.pythoncentral.io/hashing-files-with-python/">http://www.pythoncentral.io/hashing-files-with-python/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hasher = hashlib.new(hash)
    shannon = EntropyCounter()
    BLOCKSIZE = <span class="hljs-number">1024</span> * hasher.block_size
    <span class="hljs-keyword">with</span> open(filename, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> afile:</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>first buffer read does not get a nap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        buf = afile.read(BLOCKSIZE)
        <span class="hljs-keyword">while</span> len(buf) &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">with</span> nap:
                hasher.update(buf)
                shannon.update(buf)
                buf = afile.read(BLOCKSIZE)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'size'</span>: os.path.getsize(filename),
        hasher.name: hasher.hexdigest(),
        <span class="hljs-string">'path'</span>: filename,
        <span class="hljs-string">'efficiency'</span>: shannon.efficiency(),
    }


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_s3_key</span><span class="hljs-params">(key, hashtype, nap)</span>:</span>
    <span class="hljs-string">""" returns a dict of hash and size in bytes """</span>
    hasher = hashlib.new(hashtype)
    shannon = EntropyCounter()
    BLOCKSIZE = <span class="hljs-number">1024</span> * hasher.block_size</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><a href="http://boto.readthedocs.org/en/latest/ref/s3.html#boto.s3.key.Key.read">boto.s3.key.Key.read</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    buf = key.read(BLOCKSIZE)  <span class="hljs-comment"># first buffer read does not get a nap</span>
    <span class="hljs-keyword">while</span> len(buf) &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">with</span> nap:
            hasher.update(buf)
            shannon.update(buf)
            buf = key.read(BLOCKSIZE)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'size'</span>: key.size,
        hasher.name: hasher.hexdigest(),
        <span class="hljs-string">'path'</span>: <span class="hljs-string">'s3://{0}/{1}'</span>.format(key.bucket.name, key.name),
        <span class="hljs-string">'efficiency'</span>: shannon.efficiency(),
    }


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EntropyCounter</span><span class="hljs-params">(object)</span>:</span>
    <span class="hljs-string">""" calculate entropy of a file
    """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>based on <a href="http://code.activestate.com/recipes/577476-shannon-entropy-calculation/#c9">ActiveState Code » Recipes » Shannon Entropy Calculation (Python recipe)</a>
Created by FB36 on Mon, 29 Nov 2010 (MIT)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, default=None)</span>:</span>
        self.byte_freq = [<span class="hljs-number">0</span>] * <span class="hljs-number">256</span>
        self.byte_total = <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span><span class="hljs-params">(self, data)</span>:</span>
        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> bytearray(data):
            self.byte_freq[b] += <span class="hljs-number">1</span>
            self.byte_total += <span class="hljs-number">1</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">entropy</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""bits per byte symbol (shannon entropy)"""</span>
        ent = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> self.byte_freq:
            <span class="hljs-keyword">if</span> f &gt; <span class="hljs-number">0</span>:
                freq = float(f) / self.byte_total
                ent = ent + freq * math.log(freq, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">return</span> -ent

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">efficiency</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""bits per bit (float 0 to 1) theoretical efficiency"""</span>
        <span class="hljs-keyword">if</span> self.byte_total == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> self.entropy() / <span class="hljs-number">8</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fixity_checker_report</span><span class="hljs-params">(observations, outputdir)</span>:</span>
    <span class="hljs-string">""" output a listing of our memories """</span>
    logging.debug(<span class="hljs-string">"{0}, {1}"</span>.format(observations, outputdir))
    shards = defaultdict(dict)
    _mkdir(outputdir)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>sort into bins for transport</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> six.iteritems(observations):</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>first two characters are the key to the “shard”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        shards[key[:<span class="hljs-number">2</span>]].update({key: value})</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>write out json for each bin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> six.iteritems(shards):
        out = os.path.join(outputdir, <span class="hljs-string">''</span>.join([key, <span class="hljs-string">'.json'</span>]))
        <span class="hljs-keyword">with</span> open(out, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> outfile:
            json.dump(shards[key], outfile, sort_keys=<span class="hljs-keyword">True</span>,
                      indent=<span class="hljs-number">4</span>, separators=(<span class="hljs-string">','</span>, <span class="hljs-string">': '</span>))
    <span class="hljs-keyword">del</span> shards


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">track_error</span><span class="hljs-params">(path, message, errors)</span>:</span>
    <span class="hljs-string">"""log errors and note the problem files"""</span>
    logging.warning(message)
    filename_key = hashlib.sha224(path.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest()</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><code>errors</code> is a persisted dict (keyed on the sha244 of the file path).
the values in errrors consist of a dict of messages
if an error has already been seen, it will just be set to
True again each time it is noted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    note = {message: <span class="hljs-keyword">True</span>}
    <span class="hljs-keyword">if</span> filename_key <span class="hljs-keyword">in</span> errors:
        errors[filename_key].update(note)
    <span class="hljs-keyword">else</span>:
        errors[filename_key] = note
    errors.sync()</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>⌦
following functions impliment subcommands
⌦</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init</span><span class="hljs-params">(args)</span>:</span>
    <span class="hljs-string">""" setup wizard """</span>
    conf = args.config_dir</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>don’t run more than once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span>(os.path.exists(conf)), \
        <span class="hljs-string">"{0} directory specified for init must not exist"</span>.format(conf)

    data_url_default = <span class="hljs-string">'file://{0}/'</span>.format(os.path.abspath(
                                            os.path.join(conf,
                                                         <span class="hljs-string">'fixity_data_raw'</span>)))</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>TODO; any/all config options can be passed to init</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> args.archive_paths:
        directories = [os.path.abspath(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> args.archive_paths]
        _init(conf, directories, data_url_default, <span class="hljs-string">'sha512'</span>)
        show_conf(_parse_conf(args), <span class="hljs-keyword">None</span>)
        exit(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>⏏  exit the program</p>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><strong>
</strong> run the install interactive script
**</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    prompt(<span class="hljs-string">"Initalize a new checker server at {0} [Yes/no]?"</span>.format(conf),
           confirm_or_die)

    directories = multi_prompt(
        <span class="hljs-string">"Enter directories(s) or file(s) to watch, one per line"</span>,
        valid_path,
    )
    print(directories)

    data_url = default(
        <span class="hljs-string">"Enter data_url for persisted fixity data"</span>,
        data_url_default,</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>check that it is a valid URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    )
    print(data_url)

    <span class="hljs-keyword">try</span>:
        hashlib_algorithms = hashlib.algorithms
    <span class="hljs-keyword">except</span>:
        hashlib_algorithms = tuple(hashlib.algorithms_available)

    pp(list(hashlib_algorithms))

    hash = default(
        <span class="hljs-string">'Pick a hashlib'</span>,
        <span class="hljs-string">'sha512'</span>,
        <span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">in</span> hashlib_algorithms + (<span class="hljs-string">''</span>,),
        <span class="hljs-string">' '</span>.join(hashlib_algorithms)
    )
    print(hash)

    _init(conf, directories, data_url, hash)
    show_conf(_parse_conf(args), <span class="hljs-keyword">None</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init</span><span class="hljs-params">(conf, directories, data_url, hash)</span>:</span>
    <span class="hljs-string">""" set up the application directory """</span>
    data = {
        <span class="hljs-string">'__name__'</span>: <span class="hljs-string">"{0}_{1}_conf"</span>.format(APP_NAME, __version__),
        <span class="hljs-string">'archive_paths'</span>: directories,
        <span class="hljs-string">'ignore_paths'</span>: [],
        <span class="hljs-string">'data_url'</span>: data_url,
        <span class="hljs-string">'hashlib'</span>: [hash],
        <span class="hljs-string">'loglevel'</span>: <span class="hljs-string">'INFO'</span>,
        <span class="hljs-string">'min_loop'</span>: <span class="hljs-number">43200</span>,          <span class="hljs-comment"># twice a day</span>
        <span class="hljs-string">'sleepiness'</span>: <span class="hljs-number">1</span>
    }
    os.mkdir(conf)
    os.mkdir(os.path.join(conf, <span class="hljs-string">'logs'</span>))
    <span class="hljs-keyword">with</span> open(
        os.path.join(conf, <span class="hljs-string">'conf_{0}.json'</span>.format(APP_NAME)),
        <span class="hljs-string">'w'</span>,
    ) <span class="hljs-keyword">as</span> outfile:
        json.dump(data, outfile, sort_keys=<span class="hljs-keyword">True</span>,
                  indent=<span class="hljs-number">4</span>, separators=(<span class="hljs-string">','</span>, <span class="hljs-string">': '</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>TODO create .gitignore and activate(setting CHECKER_DIR)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">with</span> open(
        os.path.join(conf, <span class="hljs-string">'activate'</span>),
        <span class="hljs-string">'w'</span>,
    ) <span class="hljs-keyword">as</span> outfile:
        outfile.write(<span class="hljs-string">'export CHECKER_DIR={0}'</span>.format(conf))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_parse_conf</span><span class="hljs-params">(args)</span>:</span>
    <span class="hljs-string">"""parse and validate conf, returns nested named tuple"""</span>
    conf = args.config_dir
    <span class="hljs-keyword">assert</span> os.path.isdir(conf), \
        <span class="hljs-string">"configuration directory {0} does not exist, run init"</span>.format(conf)
    conf_file = os.path.join(conf, <span class="hljs-string">'conf_{0}.json'</span>.format(APP_NAME))
    <span class="hljs-keyword">assert</span> os.path.isfile(conf_file), \
        <span class="hljs-string">"configuration file does not exist {0}, \
        not properly initialized"</span>.format(conf_file)
    <span class="hljs-keyword">with</span> open(conf_file) <span class="hljs-keyword">as</span> f:
        data = json.load(f)</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>validate data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">assert</span> <span class="hljs-string">'data_url'</span> <span class="hljs-keyword">in</span> data, \
        <span class="hljs-string">"data_url': '' not found in {0}"</span>.format(conf_file)
    <span class="hljs-keyword">assert</span> <span class="hljs-string">'archive_paths'</span> <span class="hljs-keyword">in</span> data, \
        <span class="hljs-string">"'archive_paths': [] not found in {0}"</span>.format(conf_file)
    <span class="hljs-keyword">assert</span> <span class="hljs-string">'min_loop'</span> <span class="hljs-keyword">in</span> data, \
        <span class="hljs-string">"'min_loop': [] not found in {0}"</span>.format(conf_file)</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>build up nested named tuple to hold parsed config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    app_config = namedtuple(
        <span class="hljs-string">'fixity'</span>,
        <span class="hljs-string">'json_dir, conf_file, errors, ignore_re'</span>,
    )
    daemon_config = namedtuple(<span class="hljs-string">'FixityDaemon'</span>, <span class="hljs-string">'pid, log'</span>, )
    daemon_config.pid = os.path.abspath(
        os.path.join(conf, <span class="hljs-string">'logs'</span>, <span class="hljs-string">'{0}.pid'</span>.format(APP_NAME)))
    daemon_config.log = os.path.abspath(
        os.path.join(conf, <span class="hljs-string">'logs'</span>, <span class="hljs-string">'{0}.log'</span>.format(APP_NAME)))
    app_config.json_dir = os.path.abspath(os.path.join(conf, <span class="hljs-string">'json_dir'</span>))
    app_config.errors = os.path.abspath(os.path.join(conf, <span class="hljs-string">'errors'</span>))
    <span class="hljs-keyword">if</span> <span class="hljs-string">'ignore_paths'</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">and</span> data[<span class="hljs-string">'ignore_paths'</span>] != []:</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p><a href="http://stackoverflow.com/a/5141829/1763984">http://stackoverflow.com/a/5141829/1763984</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app_config.ignore_re = <span class="hljs-string">r'|'</span>.join(
            [fnmatch.translate(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data[<span class="hljs-string">'ignore_paths'</span>]]
        ) <span class="hljs-keyword">or</span> <span class="hljs-string">r'$.'</span>
    <span class="hljs-keyword">else</span>:
        app_config.ignore_re = <span class="hljs-keyword">False</span>
    c = namedtuple(<span class="hljs-string">'FixityConfig'</span>, <span class="hljs-string">'app, daemon, args, data, conf_file'</span>)
    c.app = app_config
    c.daemon = daemon_config
    c.args = args
    c.data = data
    c.conf_file = os.path.abspath(conf_file)
    <span class="hljs-keyword">return</span> c


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_conf</span><span class="hljs-params">(conf, ____)</span>:</span>
    <span class="hljs-string">"""report on the conf"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'log_file'</span> <span class="hljs-keyword">in</span> conf.args <span class="hljs-keyword">and</span> conf.args.log_file:
        print(conf.daemon.log)
        exit(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>⏏  exit the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-string">'pid_file'</span> <span class="hljs-keyword">in</span> conf.args <span class="hljs-keyword">and</span> conf.args.pid_file:
        print(conf.daemon.pid)
        exit(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>⏏  exit the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-string">'dir'</span> <span class="hljs-keyword">in</span> conf.args <span class="hljs-keyword">and</span> conf.args.dir:
        print(os.path.abspath(conf.args.config_dir))
        exit(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>⏏  exit the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    print()
    print(<span class="hljs-string">'cursory check of {0} {1} config in "{2}" looks OK'</span>.format(
        APP_NAME, __version__, conf.args.config_dir)
    )
    print(<span class="hljs-string">"conf file"</span>)
    print(<span class="hljs-string">'\t{0}'</span>.format(conf.conf_file))
    print(<span class="hljs-string">"pid file"</span>)
    print(<span class="hljs-string">'\t{0}'</span>.format(conf.daemon.pid))
    print(<span class="hljs-string">"log file"</span>)
    print(<span class="hljs-string">'\t{0}'</span>.format(conf.daemon.log))
    print(<span class="hljs-string">"archive paths"</span>)
    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> conf.data[<span class="hljs-string">'archive_paths'</span>]:
        missing = <span class="hljs-string">''</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(os.path.isdir(d) <span class="hljs-keyword">or</span> os.path.isfile(d)):
            missing = <span class="hljs-string">'!! MISSING !!\a'</span>
        print(<span class="hljs-string">'\t{0} {1}'</span>.format(d, missing))
    <span class="hljs-keyword">if</span> conf.app.ignore_re:
        print(<span class="hljs-string">"ignore paths"</span>)
        <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> conf.data[<span class="hljs-string">'ignore_paths'</span>]:
            print(<span class="hljs-string">'\t{0}'</span>.format(d))
        print(<span class="hljs-string">'\t\tregex {0}'</span>.format(conf.app.ignore_re))
    print()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span><span class="hljs-params">(conf, daemon)</span>:</span>
    <span class="hljs-string">"""daemon and fixity status report"""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>daemonocle exits <code>0</code> when ‘not running’, capture STDOUT
<a href="http://stackoverflow.com/a/1983450/1763984">http://stackoverflow.com/a/1983450/1763984</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">captureSTDOUT</span><span class="hljs-params">(thefun, *a, **k)</span>:</span>
        savstdout = sys.stdout
        sys.stdout = cStringIO()
        <span class="hljs-keyword">try</span>:
            thefun(*a, **k)
        <span class="hljs-keyword">finally</span>:
            v = sys.stdout.getvalue()
            sys.stdout = savstdout
        <span class="hljs-keyword">return</span> v

    output = captureSTDOUT(daemon.do_action, <span class="hljs-string">'status'</span>)
    print(output)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'not running'</span> <span class="hljs-keyword">in</span> output:
        exit(<span class="hljs-number">2</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>⏏  exit the program with an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">errors</span><span class="hljs-params">(conf, daemon)</span>:</span>
    <span class="hljs-string">""" check for un-cleared errors with files"""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>persisted dict interface for long term memory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    errors = Shove(<span class="hljs-string">'file://{0}'</span>.format(conf.app.errors), protocol=<span class="hljs-number">2</span>, flag=<span class="hljs-string">'r'</span>)
    <span class="hljs-keyword">if</span> any(errors):
        print(<span class="hljs-string">"errors found"</span>)
        <span class="hljs-keyword">for</span> path, error <span class="hljs-keyword">in</span> six.iteritems(errors):
            pp(error)
        errors.close()
        exit(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>⏏  exit the program with an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">"no errors found - OK"</span>)
        print()
        errors.close()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">json_report</span><span class="hljs-params">(conf, daemon)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>persisted dict interface for long term memory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    observations = Shove(conf.data[<span class="hljs-string">'data_url'</span>], protocol=<span class="hljs-number">2</span>, flag=<span class="hljs-string">'r'</span>)
    fixity_checker_report(observations, conf.args.report_directory[<span class="hljs-number">0</span>])
    observations.close()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">json_load</span><span class="hljs-params">(conf, daemon)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>TODO — also add bagit and checkm loaders?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pp(conf.args)
    print(<span class="hljs-string">"not implimented"</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extent</span><span class="hljs-params">(conf, daemon)</span>:</span>
    observations = Shove(conf.data[<span class="hljs-string">'data_url'</span>], protocol=<span class="hljs-number">2</span>, flag=<span class="hljs-string">'r'</span>)
    count = namedtuple(
        <span class="hljs-string">'Counts'</span>,
        <span class="hljs-string">'files, bytes, uniqueFiles, uniqueBytes, minBytes, minUniqueBytes'</span>
    )
    count.bytes = count.files = count.uniqueFiles = count.uniqueBytes = <span class="hljs-number">0</span>
    count.minBytes = count.minUniqueBytes = <span class="hljs-number">0</span>
    dedup = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>this can take a while, let the user know we are working on it
<a href="http://stackoverflow.com/a/4995896/1763984">http://stackoverflow.com/a/4995896/1763984</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">spinning_cursor</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
            <span class="hljs-keyword">for</span> cursor <span class="hljs-keyword">in</span> <span class="hljs-string">'|/-\\'</span>:
                <span class="hljs-keyword">yield</span> cursor

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">spin_cursor</span><span class="hljs-params">(spinner)</span>:</span>
        <span class="hljs-keyword">if</span> sys.stdout.isatty():  <span class="hljs-comment"># don't pollute pipes</span>
            sys.stdout.write(spinner.next())
            sys.stdout.write(<span class="hljs-string">'\b'</span>)
            sys.stdout.flush()

    spinner = spinning_cursor()</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>okay, ready to count!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> six.iteritems(observations):
        count.files = int(count.files) + <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> count.files % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
            spin_cursor(spinner)
        count.bytes += value[<span class="hljs-string">'size'</span>]
        count.minBytes += value[<span class="hljs-string">'size'</span>] * value[<span class="hljs-string">'efficiency'</span>]
        hash_a = conf.data[<span class="hljs-string">'hashlib'</span>][<span class="hljs-number">0</span>]
        hash_v = value[hash_a]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(hash_v <span class="hljs-keyword">in</span> dedup):</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>have not seen this one before</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            count.uniqueFiles += <span class="hljs-number">1</span>
            count.uniqueBytes += value[<span class="hljs-string">'size'</span>]
            count.minUniqueBytes += value[<span class="hljs-string">'size'</span>] * value[<span class="hljs-string">'efficiency'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>use ‘size’ to note that I’ve seen this one;
could double check that the size has not changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dedup[hash_v] = value[<span class="hljs-string">'size'</span>]

    observations.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sizeof_fmt</span><span class="hljs-params">(num)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p><a href="http://stackoverflow.com/a/1094933/1763984">http://stackoverflow.com/a/1094933/1763984</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-string">'bytes'</span>, <span class="hljs-string">'KiB'</span>, <span class="hljs-string">'MiB'</span>, <span class="hljs-string">'GiB'</span>]:
            <span class="hljs-keyword">if</span> num &lt; <span class="hljs-number">1024.0</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"%3.1f%s"</span> % (num, x)
            num /= <span class="hljs-number">1024.0</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"%3.1f%s"</span> % (num, <span class="hljs-string">'TiB'</span>)

    print(<span class="hljs-string">'observing {0} files {1} bytes ({2}) {6:.2%} efficient compression| \
        unique {3} files {4} bytes ({5}) {7:.2%} efficient compression'</span>.format(
        count.files, count.bytes, sizeof_fmt(count.bytes),
        count.uniqueFiles, count.uniqueBytes, sizeof_fmt(count.uniqueBytes),
        count.minBytes / count.bytes,
        count.minUniqueBytes / count.uniqueBytes,)
    )
    print()</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>⌦
Functions for talking to the user during the init process
⌦</p>
<p>used in interactive configuration wizard</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prompt</span><span class="hljs-params">(prompt, validator=<span class="hljs-params">(lambda x: True)</span>, hint=None)</span>:</span>
    <span class="hljs-string">"""prompt the user for input
       :prompt: prompt text
       :validator: optional validation function
       :hint: optional hint for invalid answer
    """</span>
    user_input = input(prompt)
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> validator(user_input):
        user_input = input(prompt)
    <span class="hljs-keyword">return</span> user_input


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">default</span><span class="hljs-params">(prompt, default, validator=<span class="hljs-params">(lambda x: True)</span>, hint=None)</span>:</span>
    <span class="hljs-string">"""prompt the user for input, with default
       :prompt: prompt text
       :default: default to use if the user hits [enter]
       :validator: optional validation function
       :hint: optional hint for invalid answer
    """</span>
    user_input = input(<span class="hljs-string">"{0} [{1}]"</span>.format(prompt, default))
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> validator(user_input):
        user_input = input(<span class="hljs-string">"{0} [{1}]"</span>.format(prompt, default))
    <span class="hljs-keyword">return</span> user_input <span class="hljs-keyword">or</span> default


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multi_prompt</span><span class="hljs-params">(prompt, validator=<span class="hljs-params">(lambda x: x)</span>, hint=None)</span>:</span>
    inputs = []
    print(prompt)
    user_input = input(<span class="hljs-string">'1 &gt; '</span>)
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> validator(user_input):
        user_input = os.path.expanduser(input(<span class="hljs-string">'1 &gt; '</span>))
    inputs.append(os.path.abspath(user_input))

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>):
        sub_prompt = <span class="hljs-string">'{0} &gt; '</span>.format(i)
        user_input = os.path.expanduser(input(sub_prompt))</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>the user might not have anything more to say</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_input:
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> validator(user_input):
            user_input = os.path.expanduser(input(sub_prompt))
        inputs.append(os.path.abspath(user_input))

    <span class="hljs-keyword">return</span> inputs</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>⏢
Functions for validating user input
⏢</p>
<p>used in interactive configuration wizard</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">confirm_or_die</span><span class="hljs-params">(string)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>for [Yn] prompt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    valid = string.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">''</span>, <span class="hljs-string">'y'</span>, <span class="hljs-string">'ye'</span>, <span class="hljs-string">'yes'</span>]
    decline = string.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">'n'</span>, <span class="hljs-string">'no'</span>]
    <span class="hljs-keyword">if</span> valid:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> decline:
        sys.exit(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>⏏  exit the program with an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">'please answer yes or no, [ENTER] for yes'</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">valid_path</span><span class="hljs-params">(string)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>make sure the direcory exists (means <code>s3://</code> paths must be
edited into the config rather than entered in the wizard)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    path = os.path.expanduser(string)
    valid = os.path.isfile(path) <span class="hljs-keyword">or</span> os.path.isdir(path)
    <span class="hljs-keyword">if</span> valid:
        <span class="hljs-keyword">return</span> valid
    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">'directory of file must exist'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>⌦
incantations
⌦</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_nice</span><span class="hljs-params">(conf)</span>:</span>
    <span class="hljs-string">""" some ugly incantations to run nice and set up logging"""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>set debugging level</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    numeric_level = getattr(logging, conf.data[<span class="hljs-string">'loglevel'</span>], <span class="hljs-keyword">None</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(numeric_level, int):
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid log level: %s'</span> % conf.data[<span class="hljs-string">'loglevel'</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>logging to root logger, why not?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    logger = logging.getLogger()
    logger.setLevel(numeric_level)
    rh = logging.handlers.TimedRotatingFileHandler(
        conf.daemon.log, when=<span class="hljs-string">'midnight'</span>,
    )
    rh.setLevel(numeric_level)
    formatter = logging.Formatter(<span class="hljs-string">'%(asctime)s [%(levelname)s] %(message)s'</span>)
    rh.setFormatter(formatter)
    logger.addHandler(rh)</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>ionice… <a href="http://stackoverflow.com/a/6245160/1763984">http://stackoverflow.com/a/6245160/1763984</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    p = psutil.Process(os.getpid())</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>… if we can <a href="http://stackoverflow.com/a/34472/1763984">http://stackoverflow.com/a/34472/1763984</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> hasattr(p, <span class="hljs-string">'set_ionice'</span>):
        p.set_ionice(psutil.IOPRIO_CLASS_IDLE)</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>and be os nice for good measure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    os.nice(<span class="hljs-number">10</span>)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NapContext</span><span class="hljs-params">(object)</span>:</span>
    <span class="hljs-string">"""context manager for system-load sensitive napping
    looks at the CPU 1m load average, sleepiness, and
    function execution time.  If it can see it from
    psutil, iowait is also factored in.

    use sleepiness of 0 to make moot

    ```
        nap = NapContext(2)  # 2 is twice as sleepy

        with nap:
            disk_thrasher_functions()
    ```
    """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>NapContext() modeled on function Timer() example
<a href="http://stackoverflow.com/a/1685337/1763984">http://stackoverflow.com/a/1685337/1763984</a></p>
<p>in the future, add <code>os.POSIX_FADV_DONTNEED</code> support
needs python 3 and newer linux kernel
<a href="http://www.gossamer-threads.com/lists/python/python/1063241">http://www.gossamer-threads.com/lists/python/python/1063241</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, sleepiness=<span class="hljs-number">1</span>)</span>:</span>
        self.sleepiness = sleepiness

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__enter__</span><span class="hljs-params">(self)</span>:</span>
        self.__start = time.time()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__exit__</span><span class="hljs-params">(self, type, value, traceback)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>dynamic nap factor calculation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        elapsed = time.time() - self.__start
        load = os.getloadavg()[<span class="hljs-number">0</span>]
        nap = load * elapsed * self.sleepiness
        cpu_wait = psutil.cpu_times_percent(<span class="hljs-number">0.0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Look at iowait on Linux</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-string">'iowait'</span> <span class="hljs-keyword">in</span> cpu_wait:
            nap = nap * (<span class="hljs-number">1</span> + cpu_wait.iowait) ** <span class="hljs-number">2</span>

        time.sleep(nap)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_mkdir</span><span class="hljs-params">(newdir)</span>:</span>
    <span class="hljs-string">"""works the way a good mkdir should :)
        - already exists, silently complete
        - regular file in the way, raise an exception
        - parent directory(ies) does not exist, make them as well
    """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p><a href="http://code.activestate.com/recipes/82465-a-friendly-mkdir/">http://code.activestate.com/recipes/82465-a-friendly-mkdir/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> os.path.isdir(newdir):
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">elif</span> os.path.isfile(newdir):
        <span class="hljs-keyword">raise</span> OSError(<span class="hljs-string">"a file with the same name as the desired "</span>
                      <span class="hljs-string">"dir, '%s', already exists."</span> % newdir)
    <span class="hljs-keyword">else</span>:
        head, tail = os.path.split(newdir)
        <span class="hljs-keyword">if</span> head <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> os.path.isdir(head):
            _mkdir(head)
        <span class="hljs-keyword">if</span> tail:
            os.mkdir(newdir)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    sys.exit(main())</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>⏏  exit the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-string">"""
Copyright © 2014, Regents of the University of California
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

- Redistributions of source code must retain the above copyright notice,
  this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.
- Neither the name of the University of California nor the names of its
  contributors may be used to endorse or promote products derived from this
  software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
"""</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
